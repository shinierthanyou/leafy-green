---
title: "ManukaAnalysis"
author: "Melissa Taane"
date: "06/05/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,cache = FALSE)
library(xlsx)
library(ggplot2)
library(gplots)
library(gridExtra)
library(corrplot)
library(dplyr)
library(png)
library(grid)
library(heatmaply)
```


#### F1 Layout

Map indicates the layout of the F1 generation resulting from a cross between EC201 and EC103 parents. Column 1 is approximately lengthways facing north.

!["Map of F1 Trees"](Capture.png) 


#### Height Diagram

Diagram indicates the areas of leaf collection regarding height.
Each Tree had 10 leaves collected, 3 from Low, 4 from Mid and 3 from High. The first leaf sampled was measured twice for replication comparison.

!["Diagram of leaf collection levels"](Tree.png)


#### Import and Arrange Data

"Full.xlsx" contains measurement information from sampling with the Dualex (https://www.force-a.com/en/capteurs-optiques-optical-sensors/dualex-scientific-chlorophyll-meter/), including;

+ Surface content of chlorophyll in ?g/cm? (Chl) 

+ The index of epidermal flavanols (Flav) 

+ Nitrogen Balance Index status (NBI)

+ Epidermal Anthocyanins (Anth). 

It also contains information about the block position, the leaf height information, and presense or absence of flowering


Sheet "Dup" contains only the samples that were replicated.

```{r}
# Import Data Measures
Data <-read.xlsx("Full.xlsx", sheetName ="Full")
head(Data)

# Import Replicate Data
Dup <-read.xlsx("Full.xlsx", sheetName ="Dup")
head(Dup)

#Isolate Crimson Glory Outgroup
CG = Data[c(1:11),]
head(CG)

#Isolate East Cape 201 Parent
EC201 = Data[c(12:21),]
head(EC201)

#Isolate East Cape 103 Parent
EC103 = Data[c(22:33),]
head(EC103)

#Isolate Offspring from the Parental Cross
F1 = Data[c(34:1825),]
head(F1)
```

#### Replicate Analysis

Replicates were taken by measuring a leaf sample of each tree twice, in order to establish consistency and reliability of measurements with the Dualex.

```{r replicate means}

#Anthocyanin Mean
AMR = mean(Dup$Anth);AMR

#Chlorophyll Mean
CMR = mean(Dup$Chl);CMR

#Flavanoid Mean
FMR = mean(Dup$Flav);FMR

#NBI Mean
NMR = mean(Dup$NBI);NMR
```

##### Replicate Plots

```{r replicate plots}
#Boxplot Anthocyanin Replicates
RAnth <- ggplot(Dup) + aes(x = Rep., y = Anth) + geom_boxplot() +geom_hline(yintercept = AMR, color = "purple4") + ylab("Anthocyanin Content") + xlab("Leaf Replicate Number") + ggtitle("Anthocyanin Measurements of Two Replicate Groups") + theme_classic();plot +stat_boxplot(notch = TRUE)

#Boxplot Chlorophyll Replicates
RChl<- ggplot(Dup) + aes(x = Rep., y = Chl) + geom_boxplot(colour = "darkorchid", fill = "plum") +geom_hline(yintercept = CMR, color = "darkorchid") + ylab("Chlorophyll g/cm") + xlab("Replicate Number") + ggtitle("Comparison of Chlorophyll levels of two replicate groups") + theme_classic();plot +stat_boxplot(notch = TRUE)

#Boxplot Flavnol Replicates
RFlav <- ggplot(Dup) + aes(x = Rep., y = Flav) + geom_boxplot() +geom_hline(yintercept = FMR, color = "purple4") + ylab("Flavanold Content") + xlab("Leaf Replicate Number") + ggtitle("Flavonoid Measurements of Two Replicate Groups") + theme_classic();plot +stat_boxplot(notch = TRUE)
  
#Boxplot NBI Replicates
RNBI <- ggplot(Dup) + aes(x = Rep., y = NBI) + geom_boxplot() +geom_hline(yintercept = NMR, color = "purple4") + ylab("Nitrogen Balance Index") + xlab("Leaf Replicate Number") + ggtitle("Nitrogen Balance Index of Two Replicate Groups") + theme_classic();plot +stat_boxplot(notch = TRUE)

#Display Boxplots
grid.arrange(RChl,RNBI,RAnth,RFlav, ncol = 2)
```


##### ANOVA of Replicates

```{r}
#Chlorophyll Anova
mod <-lm(Dup$Chl ~ Dup$Rep.)
anova(mod)
#Flavanol Anova
mod2 <-lm(Dup$Flav ~ Dup$Rep.)
anova(mod2)
#Anthocyanin Anova
mod3 <-lm(Dup$Anth ~ Dup$Rep.)
anova(mod3)
#NBI Anova
mod4 <-lm(Dup$NBI ~ Dup$Rep.)
anova(mod4)
```

The absence of statistically significant results indicates that our replicates are likely to be consistent.



#### Allocation Analysis

Allocation refers to which group measurements were taken from, i.e. A Parental Tree (EC103 or EC201), Outgroup Tree (CG), Parental Offspring (F1)

```{r Allocation Means}
#Anthocyanin Mean
AMA = mean(Data$Anth);AMA
#Chlorophyll Mean
CMA = mean(Data$Chl);CMA
#Flavanol Mean
FMA = mean(Data$Flav);FMA
#NBI Mean
NMA = mean(Data$NBI);NMA
```

#### Boxplot comparing medians and measurement distributions

```{r}
#Boxplot Anthocyanin Replicates
AAnth <- ggplot(Data) + aes(x = Allocation, y = Anth) + geom_boxplot() +geom_hline(yintercept = AMA, color = "purple4") + ylab("Anthocyanin Measure") + xlab("Allocation") + ggtitle("Anthocyanin of Tree Allocation") + theme_classic();plot +stat_boxplot(notch = TRUE)

#Boxplot Chlorophyll Replicates
AChl <- ggplot(Data) + aes(x = Allocation, y = Chl) + geom_boxplot() +geom_hline(yintercept = CMA, color = "purple4") + ylab("Chlorophyll Measure") + xlab("Allocation") + ggtitle("Chlorophyll of Tree Allocation") + theme_classic();plot +stat_boxplot(notch = TRUE)

#Boxplot Flavanol Replicates
AFlav <- ggplot(Data) + aes(x = Allocation, y = Flav) + geom_boxplot() +geom_hline(yintercept = FMA, color = "purple4") + ylab("Flavanol Measure") + xlab("Allocation") + ggtitle("Flavonol of Tree Allocation") + theme_classic();plot +stat_boxplot(notch = TRUE)

#Boxplot NBI Replicates
ANBI <- ggplot(Data) + aes(x = Allocation, y = NBI) + geom_boxplot() +geom_hline(yintercept = NMA, color = "purple4") + ylab("NBI Measure") + xlab("Allocation") + ggtitle("NBI of Tree Allocation") + theme_classic();plot +stat_boxplot(notch = TRUE)

#Display Plots
grid.arrange(AAnth,AChl,AFlav,ANBI, ncol=2)
```


##### ANOVAs

```{r}
#Chlorophyll
mod5 <-lm(Data$Chl ~ Data$Allocation)
anova(mod5)
#Nitrogen
mod6 <-lm(Data$NBI ~ Data$Allocation)
anova(mod5)
#Flavanol
mod7 <-lm(Data$Flav ~ Data$Allocation)
anova(mod7)
#Anthocyanin
mod8 <-lm(Data$Anth ~ Data$Allocation)
anova(mod8)
```
#### Parent Tree Analysis

```{r t.tests}
#Binding parents into single dataset
Parent <- rbind(EC201,EC103)

#Anthocyanin Mean
AMP = mean(Parent$Anth)
#Anthocyanin Boxplot
PAnth <- ggplot(Parent) + aes(x = Tree.ID, y = Anth) + geom_boxplot() +geom_hline(yintercept = AMP, color = "purple4") + ylab("Anthocyanin Measure") + xlab("Tree ID") + ggtitle("Anthocyanin of Parent Trees") + theme_classic();plot +stat_boxplot(notch = TRUE)
#Anthocyanin histogram
PHAnth <- ggplot(Parent) + aes(x = Anth) + geom_histogram()
#Anthocyanin Display plots 
grid.arrange(PAnth, PHAnth)
#Anthocyanin T.test
t.test(Parent$Anth ~ Parent$Tree.ID)

#Chlorophyll Mean
CMP = mean(Parent$Chl)
#Chlorophyll Boxplot
PChl <- ggplot(Parent) + aes(x = Tree.ID, y = Chl) + geom_boxplot() +geom_hline(yintercept = CMP, color = "purple4") + ylab("Chlorophyll Measure") + xlab("Tree ID") + ggtitle("Chlorophyll of Parent Trees") + theme_classic();plot +stat_boxplot(notch = TRUE)
#Chlorophyll histogram
PHChl <- ggplot(Parent) + aes(x = Chl) + geom_histogram()
#Anthocyanin Display plots 
grid.arrange(PChl, PHChl)
#Anthocyanin T.test
t.test(Parent$Chl ~ Parent$Tree.ID)

#Flavonol Mean
FMP = mean(Parent$Flav)
#Anthocyanin Boxplot
PFlav <- ggplot(Parent) + aes(x = Tree.ID, y = Flav) + geom_boxplot() +geom_hline(yintercept = FMP, color = "purple4") + ylab("Flavanol Measure") + xlab("Tree ID") + ggtitle("Flavonol of Parent Trees") + theme_classic();plot +stat_boxplot(notch = TRUE)
#Anthocyanin histogram
PHFlav <- ggplot(Parent) + aes(x = Flav) + geom_histogram()
#Anthocyanin Display plots 
grid.arrange(PFlav, PHFlav)
#Anthocyanin T.test
t.test(Parent$Flav ~ Parent$Tree.ID)

#NBI Mean
NMP = mean(Parent$NBI)
#NBI Boxplot
PNBI <- ggplot(Parent) + aes(x = Tree.ID, y = NBI) + geom_boxplot() +geom_hline(yintercept = NMP, color = "purple4") + ylab("NBI Measure") + xlab("Tree ID") + ggtitle("Anthocyanin of Parent Trees") + theme_classic();plot +stat_boxplot(notch = TRUE)
#NBI histogram
PHNBI <- ggplot(Parent) + aes(x = NBI) + geom_histogram()
#Anthocyanin Display plots 
grid.arrange(PNBI, PHNBI)
#Anthocyanin T.test
t.test(Parent$NBI ~ Parent$Tree.ID)
```

#### Parental Cross Analysis (F1 Generation)

Investigating measures across the F1 cross population

```{r F1}
#Grouping F1 Measures By Tree
F12 <-group_by(F1,Tree.ID)
F12 <- summarise(F12,Chl = mean(Chl,na.rm=T), NBI = mean(NBI, ra.nm = T), Anth = mean(Anth, na.rm=T),Flav = mean(Flav,na.rm =T))
View(F12)
#Anthocyanin Mean
AMF = mean(F12$Anth);AMF
#Chlorophyll Mean
CMF = mean(F12$Chl);CMF
#Flavanol Mean
FMF = mean(F12$Flav);FMF
#NBI Mean
NMF = mean(F12$NBI); NMF
```

```{r Preliminary Look at F1}
#Boxplot Anthocyanin F1
FAnth <- ggplot(F1) + aes(x = Tree.ID, y = Anth) + geom_boxplot() +geom_hline(yintercept = AMF, color = "purple4") + ylab("Anthocyanin Measure") + xlab("Tree ID") + ggtitle("Anthocyanin of F1 population") + theme_classic();plot +stat_boxplot(notch = TRUE)
#Histogram of Anthocyanin Distribution
FHAnth <- ggplot(F12) + aes(x = Anth) + geom_histogram()
#Display Anthocyanin Plots
grid.arrange(FAnth,FHAnth)
#Anthocyanin ANOVA
FAA = lm(F1$Anth ~ F1$Tree.ID)
anova(FAA)

#Boxplot Chlorophyll F1
FChl <- ggplot(F1) + aes(x = Tree.ID, y = Chl) + geom_boxplot() +geom_hline(yintercept = CMF, color = "purple4") + ylab("Chlorophyll Measure") + xlab("Tree ID") + ggtitle("Chlorophyll of F1 Population") + theme_classic();plot +stat_boxplot(notch = TRUE)
#Histogram of Chlorophyll
FHChl <- ggplot(F12) + aes(x = Chl) + geom_histogram()
#Display Chlorophyll Plots
grid.arrange(FChl, FHChl)
#Chlorophyll ANOVA
FCA = lm(F1$Chl ~ F1$Tree.ID)
anova(FCA)

#Boxplot Flavanol F1
FFlav <- ggplot(F1) + aes(x = Tree.ID, y = Flav) + geom_boxplot() +geom_hline(yintercept = FMF, color = "purple4") + ylab("Flavanol Measure") + xlab("Tree ID") + ggtitle("Flavonol of F1 Population") + theme_classic();plot +stat_boxplot(notch = TRUE)
#Histogram of Flavonol
FHFlav <- ggplot(F12) + aes(x = Flav) + geom_histogram()
#Display Chlorophyll Plots
grid.arrange(FFlav, FHFlav)
#Flavonol ANOVA
FFA = lm(F1$Flav ~ F1$Tree.ID)
anova(FFA)

#Boxplot NBI F1
FNBI <- ggplot(F1) + aes(x = Tree.ID, y = NBI) + geom_boxplot() +geom_hline(yintercept = NMF, color = "purple4") + ylab("NBI Measure") + xlab("Tree ID") + ggtitle("NBI of F1 Population") + theme_classic();plot +stat_boxplot(notch = TRUE)
#Histogram of NBI
FHNBI <- ggplot(F1) + aes(x = NBI) + geom_histogram()
#Display NBI Plots
grid.arrange(FNBI, FHNBI)
#NBI ANOVA
FNA = lm(F1$NBI ~ F1$Tree.ID)
anova(FNA)
```

#### Height Analysis

```{r Height Analysis}
#Boxplot Anthocyanin Height
HAnth <- ggplot(F1) + aes(x = Height, y = Anth) + geom_boxplot() +geom_hline(yintercept = AMF, color = "purple4") + ylab("Anthocyanin Measure") + xlab("Height") + ggtitle("Anthocyanin of F1 population by Height") + theme_classic();plot +stat_boxplot(notch = TRUE)

#Boxplot Chlorophyll F1
HChl <- ggplot(F1) + aes(x = Height, y = Chl) + geom_boxplot() +geom_hline(yintercept = CMF, color = "purple4") + ylab("Chlorophyll Measure") + xlab("Height") + ggtitle("Chlorophyll of F1 Population") + theme_classic();plot +stat_boxplot(notch = TRUE)

#Boxplot Flavanol F1
HFlav <- ggplot(F1) + aes(x = Height, y = Flav) + geom_boxplot() +geom_hline(yintercept = FMF, color = "purple4") + ylab("Flavanol Measure") + xlab("Height") + ggtitle("Flavonol of F1 Population by Height") + theme_classic();plot +stat_boxplot(notch = TRUE)

#Boxplot NBI F1
HNBI <- ggplot(F1) + aes(x = Height, y = NBI) + geom_boxplot() +geom_hline(yintercept = NMF, color = "purple4") + ylab("NBI Measure") + xlab("Height") + ggtitle("NBI of F1 Population") + theme_classic();plot +stat_boxplot(notch = TRUE)

grid.arrange(HAnth,HChl,HFlav,HNBI)
```

```{r Height Anova}
#Anthocyanin ANOVA
HAA = lm(F1$Anth ~ F1$Height)
anova(HAA)

#Chlorophyll ANOVA
HCA = lm(F1$Chl ~ F1$Height)
anova(FCA)

#Flavonol ANOVA
HFA = lm(F1$Flav ~ F1$Height)
anova(HFA)

#NBI ANOVA
HNA = lm(F1$NBI ~ F1$Height)
anova(HNA)
```

#### Row Analysis

```{r Row Analysis}
#Grouping data by ROw
F1R = group_by(F1,Row)
F1R = summarise(F1R,Chl = mean(Chl,na.rm=T), NBI = mean(NBI, ra.nm = T), Anth = mean(Anth, na.rm=T),Flav = mean(Flav,na.rm =T))


#Boxplot Anthocyanin Height
RoAnth <- ggplot(F1) + aes(x = Row, y = Anth) + geom_boxplot() +geom_hline(yintercept = AMF, color = "purple4") + ylab("Anthocyanin Measure") + xlab("Row") + ggtitle("Anthocyanin of F1 population by Row") + theme_classic();plot +stat_boxplot(notch = TRUE)
#Histogram of Anthocyanin
RoHAnth <- ggplot(F1R) + aes(x = Anth) + geom_histogram()
#Display plots
grid.arrange(RoAnth,RoHAnth)
#Anthocyanin ANOVA
RoAA = lm(F1$Anth ~ F1$Row)
anova(RoAA)

#Boxplot Chlorophyll F1
RoChl <- ggplot(F1) + aes(x = Row, y = Chl) + geom_boxplot() +geom_hline(yintercept = CMF, color = "purple4") + ylab("Chlorophyll Measure") + xlab("Row") + ggtitle("Chlorophyll of F1 Population by Row") + theme_classic();plot +stat_boxplot(notch = TRUE)
#Histogram of Chlorophyll
RoHChl <- ggplot(F1R) + aes(x = Chl) + geom_histogram()
#Display plots
grid.arrange(RoChl,RoHChl)
#Anthocyanin ANOVA
RoCA = lm(F1$Chl ~ F1$Row)
anova(RoCA)

#Boxplot Flavanol F1
RoFlav <- ggplot(F1) + aes(x = Row, y = Flav) + geom_boxplot() +geom_hline(yintercept = FMF, color = "purple4") + ylab("Flavanol Measure") + xlab("Row") + ggtitle("Flavonol of F1 Population by Row") + theme_classic();plot +stat_boxplot(notch = TRUE)
#Histogram of Flavonol
RoHFlav <- ggplot(F1R) + aes(x = Flav) + geom_histogram()
#Display plots
grid.arrange(RoFlav,RoHFlav)
#Anthocyanin ANOVA
RoFA = lm(F1$Flav ~ F1$Row)
anova(RoFA)

#Boxplot NBI F1
RoNBI <- ggplot(F1) + aes(x = Row, y = NBI) + geom_boxplot() +geom_hline(yintercept = NMF, color = "purple4") + ylab("NBI Measure") + xlab("Row") + ggtitle("NBI of F1 Population by Row") + theme_classic();plot +stat_boxplot(notch = TRUE)
#Histogram of NBI
RoHNBI <- ggplot(F1R) + aes(x = NBI) + geom_histogram()
#Display plots
grid.arrange(RoNBI,RoHNBI)
#Anthocyanin ANOVA
RoNA = lm(F1$NBI ~ F1$Row)
anova(RoNA)
```

#### Column Analysis

```{r Column Analysis}
#Making Column Values Factors
F1$Column = as.factor(F1$Column)
#Grouping data by Column
F1C = group_by(F1,Column)
F1C = summarise(F1R,Chl = mean(Chl,na.rm=T), NBI = mean(NBI, ra.nm = T), Anth = mean(Anth, na.rm=T),Flav = mean(Flav,na.rm =T))

#Boxplot Anthocyanin Height
CAnth <- ggplot(F1) + aes(x = Column, y = Anth) + geom_boxplot() +geom_hline(yintercept = AMF, color = "purple4") + ylab("Anthocyanin Measure") + xlab("Column") + ggtitle("Anthocyanin of F1 population by Column") + theme_classic();plot +stat_boxplot(notch = TRUE);CAnth
#Anthocyanin ANOVA
CAA = lm(F1$Anth ~ F1$Column)
anova(CAA)

#Boxplot Chlorophyll F1
CChl <- ggplot(F1) + aes(x = Column, y = Chl) + geom_boxplot() +geom_hline(yintercept = CMF, color = "purple4") + ylab("Chlorophyll Measure") + xlab("Column") + ggtitle("Chlorophyll of F1 Population by Column") + theme_classic();plot +stat_boxplot(notch = TRUE);CChl
#Anthocyanin ANOVA
CCA = lm(F1$Chl ~ F1$Column)
anova(CCA)

#Boxplot Flavanol F1
CFlav <- ggplot(F1) + aes(x = Column, y = Flav) + geom_boxplot() +geom_hline(yintercept = FMF, color = "purple4") + ylab("Flavanol Measure") + xlab("Column") + ggtitle("Flavonol of F1 Population by Column") + theme_classic();plot +stat_boxplot(notch = TRUE);CFlav
#Anthocyanin ANOVA
CFA = lm(F1$Flav ~ F1$Column)
anova(CFA)

#Boxplot NBI F1
CNBI <- ggplot(F1) + aes(x = Column, y = NBI) + geom_boxplot() +geom_hline(yintercept = NMF, color = "purple4") + ylab("NBI Measure") + xlab("Column") + ggtitle("NBI of F1 Population by Column") + theme_classic();plot +stat_boxplot(notch = TRUE);CNBI
#Anthocyanin ANOVA
CNA = lm(F1$NBI ~ F1$Column)
anova(CNA)
```

```{r interactive terms}
#Anthocyanin
CRHA = lm(F1$Anth ~ F1$Height*F1$Column*F1$Row)
anova(CRHA)
#Remove insignificant variables
CRHA2 = lm(F1$Anth ~ F1$Height*F1$Row)
anova(CRHA2)

#Chlorophyll
CRHC = lm(F1$Chl ~ F1$Height*F1$Column*F1$Row)
anova(CRHC)
#Remove insignificant variables
CRHC2 = lm(F1$Chl ~ F1$Height*F1$Row)
anova(CRHC2)
#Further Remove insignificant variables
CRHC3 = lm(F1$Chl ~ F1$Row)
anova(CRHC3)

#Flavonol
CRHF = lm(F1$Flav ~ F1$Height*F1$Column*F1$Row)
anova(CRHF)

#NBI
CRHN = lm(F1$NBI ~ F1$Height*F1$Column*F1$Row)
anova(CRHN)
#Remove insignificant variables
CRHM2 = lm(F1$NBI ~ F1$Row*F1$Column)
anova(CRHM2)
```

```{r controlling for Height}
#Select Column,Row,Height,Tree.ID,Flav,Anth
xF = F1[c(4,5,8,11,14,15)]
xF = group_by(xF, Height, Row, Column,Tree.ID)
xF = summarise(xF, Anth = mean(Anth, na.rm=T),Flav = mean(Flav,na.rm =T))
#Write to excel
#write.xlsx(as.data.frame(xF), file = "xF.xlsx", sheetName = "Height", col.names = T)
#Import altered data
HDat <-read.xlsx("xF2.xlsx", sheetName ="Sheet2")
#New Anthocyanin Anova
AHA = lm(HDat$Anth ~ HDat$Height)
anova(AHA)
#New Flavonol Anova
FHA = lm(HDat$Flav ~ HDat$Height)
anova(FHA)
```

```{r controlling for column}
#Select Column for Row, Column, Tree.ID, Flav, NBI
zF = F1[c(4,5,8,14,16)]
View(zF)
zF = group_by(zF,Column,Row,Tree.ID)
zF = summarise(zF, Flav = mean(Flav, na.rm = T), NBI = mean(NBI, na.rm = T))
#Write to excel
#write.xlsx(as.data.frame(zF), file = "zF.xlsx", sheetName = "Column", col.names = T)
#Import altered data
CDat = read.xlsx("zF2.xlsx", sheetName = "Sheet2")
#New Flavonol Anova
FCA = lm(CDat$Flav ~ CDat$Column)
anova(FCA)
#New NBI Anova
NCA = lm(CDat$NBI ~ CDat$Column)
anova(NCA)
```

```{r controlling for row}
vF = F1[c(4,5,8,13,14,15,16)]
vF = group_by(vF,Column,Row,Tree.ID)
vF = summarise(vF, Flav = mean(Flav, na.rm = T), NBI = mean(NBI, na.rm = T), Anth = mean(Anth, na.rm = T), Chl = mean(Chl, na.rm = T))
#Write to excel
#write.xlsx(as.data.frame(vF), file = "vF.xlsx", sheetName = "Row", col.names = T)
#Import altered data
RDat = read.xlsx("vF2.xlsx", sheetName = "Sheet5")
#New Anthocyanin anova
CAlm = lm(RDat$Anth ~ RDat$Row)
anova(CAlm)
#New Chlorophyll anova
CClm = lm(RDat$Chl ~ RDat$Row)
anova(CClm)
#New Flavonol anova
CFlm = lm(RDat$Flav ~ RDat$Row)
anova(CFlm)
```